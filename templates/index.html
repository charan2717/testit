<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Omegle Clone - Video Chat</title>
  <style>
    #video-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 50px;
    }
    video {
      width: 320px;
      height: 240px;
      background: #000;
      border-radius: 10px;
    }
    #chat-container {
      margin: 20px auto;
      width: 650px;
      border: 1px solid #ddd;
      padding: 10px;
      font-family: Arial, sans-serif;
    }
    #messages {
      height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    #messageInput {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    #controls {
      text-align: center;
      margin-top: 15px;
    }
    button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div id="video-container">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<div id="chat-container">
  <div id="messages"></div>
  <input type="text" id="messageInput" placeholder="Type a message and hit Enter..." />
</div>

<div id="controls">
  <button id="startBtn">Start Chat</button>
  <button id="nextBtn" style="display:none;">Next</button>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
  const startBtn = document.getElementById('startBtn');
  const nextBtn = document.getElementById('nextBtn');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');

  const socket = io();

  let localStream = null;
  let peerConnection = null;
  let roomId = null;

  // Use Google's public STUN server
  const iceServers = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  };

  // Utility to append chat messages
  function addMessage(msg) {
    const p = document.createElement('p');
    p.textContent = msg;
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Setup peer connection and event handlers
  function createPeerConnection() {
    peerConnection = new RTCPeerConnection(iceServers);

    // Add local stream tracks to peer connection
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = event => {
      // Set remote video stream
      remoteVideo.srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        socket.emit('signal', { room: roomId, signal: { type: 'candidate', candidate: event.candidate } });
      }
    };

    peerConnection.onconnectionstatechange = () => {
      if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'closed') {
        cleanup();
        addMessage("Peer disconnected.");
      }
    };
  }

  async function startLocalStream() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    } catch (err) {
      alert("Could not get user media: " + err);
    }
  }

  function cleanup() {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    remoteVideo.srcObject = null;
    roomId = null;
  }

  // Handle socket events

  socket.on('partner_found', async (data) => {
    roomId = data.room;
    addMessage("Partner found! Setting up connection...");

    createPeerConnection();

    // Create an offer if we are the caller (decide by comparing socket ids)
    if (socket.id < data.room) {
      // Caller creates offer
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('signal', { room: roomId, signal: { type: 'offer', sdp: offer.sdp } });
    }
  });

  socket.on('signal', async (data) => {
    if (!peerConnection) {
      createPeerConnection();
    }
    const signal = data.signal;

    if (signal.type === 'offer') {
      await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: signal.sdp }));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit('signal', { room: roomId, signal: { type: 'answer', sdp: answer.sdp } });
    } else if (signal.type === 'answer') {
      await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: signal.sdp }));
    } else if (signal.type === 'candidate') {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
      } catch (err) {
        console.error("Error adding received ice candidate", err);
      }
    }
  });

  socket.on('chat_message', data => {
    addMessage("Stranger: " + data.message);
  });

  // Button handlers

  startBtn.onclick = async () => {
    await startLocalStream();
    socket.emit('join');
    startBtn.style.display = 'none';
    nextBtn.style.display = 'inline-block';
  };

  nextBtn.onclick = () => {
    cleanup();
    socket.emit('join');
    messagesDiv.innerHTML = '';
  };

  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && messageInput.value.trim() !== '') {
      const message = messageInput.value;
      socket.emit('chat_message', { room: roomId, message });
      addMessage("You: " + message);
      messageInput.value = '';
    }
  });
</script>

</body>
</html>
